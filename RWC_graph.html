<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>7-Day Tide Forecast</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }
  .card {
    background: white;
    border-radius: 12px;
    padding: 24px 32px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 900px;
  }
  h2 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: #333;
  }
  #subtitle {
    font-size: 12px;
    color: #aaa;
    margin-bottom: 16px;
  }
  #status {
    font-size: 12px;
    color: #aaa;
    text-align: center;
    margin-top: 8px;
  }
</style>
</head>
<body>
<div class="card">
  <h2>7-Day Tide Forecast — Redwood City</h2>
  <div id="subtitle">NOAA Station 9414523 · Datum: NAVD88</div>
  <canvas id="chart"></canvas>
  <div id="status">Loading...</div>
</div>

<script>
var STATION = "9414523";
var DATUM = "NAVD";
var MHHW = 7.02;  // ← MHHW in NAVD88 feet

function fmt(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1);
  var day = String(d.getDate());
  if (m.length < 2) m = '0' + m;
  if (day.length < 2) day = '0' + day;
  return y + m + day;
}

var today = new Date();
var end = new Date();
end.setDate(today.getDate() + 6);

// Use 6-minute interval for a smooth chart
var url = 'https://api.tidesandcurrents.noaa.gov/api/prod/datagetter'
  + '?product=predictions'
  + '&station=' + STATION
  + '&begin_date=' + fmt(today)
  + '&end_date=' + fmt(end)
  + '&datum=' + DATUM
  + '&time_zone=lst_ldt'
  + '&interval=h'
  + '&units=english'
  + '&format=json';

var xhr = new XMLHttpRequest();
xhr.open('GET', url, true);
xhr.onload = function() {
  try {
    var json = JSON.parse(xhr.responseText);
    if (json.error) {
      document.getElementById('status').textContent = 'NOAA error: ' + json.error.message;
      return;
    }

    var labels = [];
    var values = [];
    var preds = json.predictions;

    for (var i = 0; i < preds.length; i++) {
      labels.push(preds[i].t);
      values.push(parseFloat(preds[i].v));
    }

    var ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Predicted Tide (ft)',
            data: values,
            borderColor: '#1a3a5c',
            backgroundColor: 'rgba(26,58,92,0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            tension: 0.4
          },
          {
            label: 'MHHW (7.02 ft NAVD)',
            data: new Array(labels.length).fill(MHHW),
            borderColor: '#e05c2a',
            borderWidth: 2,
            borderDash: [6, 4],
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' ft';
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 14,
              maxRotation: 45,
              callback: function(val, index) {
                // Show only date labels, not every hour
                var label = this.getLabelForValue(val);
                if (label && label.endsWith('00:00')) return label.split(' ')[0];
                return '';
              }
            }
          },
          y: {
            title: { display: true, text: 'Tide Height (ft NAVD)' },
            ticks: {
              callback: function(val) { return val.toFixed(1) + ' ft'; }
            }
          }
        }
      }
    });

    document.getElementById('status').textContent = 
      'Hourly predictions · ' + preds.length + ' data points · Last loaded: ' + new Date().toLocaleTimeString();

  } catch(e) {
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
};
xhr.onerror = function() {
  document.getElementById('status').textContent = 'Network error - check connection';
};
xhr.timeout = 10000;
xhr.ontimeout = function() {
  document.getElementById('status').textContent = 'Request timed out';
};
xhr.send();
</script>
</body>
</html>
